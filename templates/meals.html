{% extends "base.html" %}

{% block title %}FitPlan - Meal Plan{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<style>
    .day-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        gap: 10px;
    }
    
    .day-nav-btn {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .day-nav-btn:hover:not(:disabled) {
        background: #5568d3;
        transform: translateY(-1px);
    }
    
    .day-nav-btn:disabled {
        background: #e1e8ed;
        color: #999;
        cursor: not-allowed;
    }
    
    .day-indicator {
        flex: 1;
        text-align: center;
        font-weight: 600;
        font-size: 13px;
        color: #333;
    }
    
    .day-content {
        display: none;
    }
    
    .day-content.active {
        display: block;
    }
    
    .recipe-link {
        color: #667eea;
        text-decoration: none;
        font-size: 11px;
        font-weight: 600;
        margin-top: 8px;
        display: inline-block;
    }
    
    .recipe-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="phone-frame">
    <div class="plan-header">
        <div class="app-logo">ü•ó</div>
        <div class="app-name">Your Meal Plan</div>
        <div class="app-tagline">
            {% if meal_plan and meal_plan.days %}
                {% set first_day = meal_plan.days[1] %}
                {{ first_day.target_calories|int or 'Custom' }} cal/day
            {% endif %}
        </div>
    </div>
    
    <div class="scrollable-content">
        {% if meal_plan and meal_plan.days %}
            <!-- Day Navigation -->
            <div class="day-navigation">
                <button class="day-nav-btn" id="prevDayBtn" onclick="changeDay(-1)" style="width:95px">
                    ‚Üê Previous
                </button>
                <div class="day-indicator" id="dayIndicator">Loading...</div>
                <button class="day-nav-btn" id="nextDayBtn" onclick="changeDay(1)" style="width:95px">
                    Next ‚Üí
                </button>
            </div>
            
            <!-- Day Content Containers (days 1-7) -->
            {% for day_num in range(1, 8) %}
                {% set day_data = meal_plan.days[day_num] %}
                <div class="day-content" data-day="{{ day_num }}" id="day-{{ day_num }}">
                    <h3 style="font-size: 14px; margin-bottom: 10px; text-align: center; color: #333;">
                        {{ day_data.day_name }}, {{ day_data.date }}
                    </h3>
                    
                    {% for meal in day_data.meals %}
                        <div class="meal-card">
                            <div class="meal-header">
                                <div class="meal-title">
                                    {% if meal.type == 'breakfast' %}üåÖ
                                    {% elif meal.type == 'lunch' %}ü•ó
                                    {% elif meal.type == 'dinner' %}üçΩÔ∏è
                                    {% elif meal.type == 'snack' %}ü•ú
                                    {% endif %}
                                    {{ meal.title }}
                                </div>
                                <div class="meal-calories">{{ meal.calories }} cal</div>
                            </div>
                            <div class="meal-description">{{ meal.description }}</div>
                            <div class="macros">
                                <span>P: {{ meal.macros.protein }}</span>
                                <span>C: {{ meal.macros.carbs }}</span>
                                <span>F: {{ meal.macros.fat }}</span>
                            </div>
                            
                            <!-- Recipe Link -->
                            {% if meal.ingredients and meal.instructions %}
                                <a href="#" class="recipe-link" 
                                   onclick="viewRecipe({{ day_num }}, {{ loop.index0 }}, event)">
                                    üìñ View Recipe
                                </a>
                            {% endif %}
                        </div>
                    {% endfor %}
                    
                    <div class="summary-box">
                        <div class="summary-row">
                            <span>Daily Target:</span>
                            <span>{{ day_data.target_calories|int }} calories</span>
                        </div>
                        <div class="summary-row">
                            <span>Actual Total:</span>
                            <span>{{ day_data.actual_calories|int }} calories</span>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <p>No meal plan available. Please complete your profile first.</p>
            </div>
        {% endif %}
    </div>
    
    <div class="navigation">
        <a href="{{ url_for('dashboard') }}">
            <button class="btn-secondary">‚Üê Back to Dashboard</button>
        </a>
    </div>
</div>

<!-- Hidden data for JavaScript -->
<script id="meal-plan-data" type="application/json">
    {{ meal_plan | tojson | safe }}
</script>

<script>
// Meal plan data
let mealPlanData = null;
let currentDayIndex = {{ current_day }}; // 1-7 from server

// Day names for display
const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Load meal plan data
    const dataElement = document.getElementById('meal-plan-data');
    if (dataElement) {
        mealPlanData = JSON.parse(dataElement.textContent);
        if (mealPlanData && mealPlanData.days) {
            showDay(currentDayIndex);
        }
    }
});

// Show specific day (1-7)
function showDay(dayNum) {
    if (dayNum < 1 || dayNum > 7) return;
    
    currentDayIndex = dayNum;
    
    // Hide all days
    document.querySelectorAll('.day-content').forEach(el => {
        el.classList.remove('active');
    });
    
    // Show current day
    const currentDay = document.getElementById(`day-${dayNum}`);
    if (currentDay) {
        currentDay.classList.add('active');
        
        // Get the actual date from the day data
        const dayData = mealPlanData.days[dayNum];
        const displayText = `${dayData.day_name.substring(0, 3)}, ${dayData.date}`;
        document.getElementById('dayIndicator').textContent = displayText;
    }
    
    // Update button states
    document.getElementById('prevDayBtn').disabled = (dayNum === 1);
    document.getElementById('nextDayBtn').disabled = (dayNum === 7);
    
    // Scroll to top
    const scrollableContent = document.querySelector('.scrollable-content');
    if (scrollableContent) {
        scrollableContent.scrollTop = 0;
    }
}

// Change day (Previous/Next)
function changeDay(direction) {
    const newDayNum = currentDayIndex + direction;
    if (newDayNum >= 1 && newDayNum <= 7) {
        showDay(newDayNum);
    }
}

// View recipe - navigate to recipe page with data
function viewRecipe(dayNum, mealIndex, event) {
    event.preventDefault();
    
    if (!mealPlanData || !mealPlanData.days || !mealPlanData.days[dayNum]) {
        alert('Recipe data not available');
        return;
    }
    
    const meal = mealPlanData.days[dayNum].meals[mealIndex];
    
    // Store meal data in sessionStorage for recipe page
    sessionStorage.setItem('currentRecipe', JSON.stringify(meal));
    
    // Navigate to recipe page
    window.location.href = '/recipe?day=' + dayNum + '&meal=' + mealIndex;
}
</script>
{% endblock %}
